# Тестовое задание — WeRent

Этот проект — тестовое задание от компании **WeRent**.  
Включает в себя **два задания**, реализованных с использованием Docker, PHP, Node.js, PostgreSQL и Redis.

## Задания

### 1. PHP-скрипт с блокировкой в Redis

**Задача**:  
Написать PHP-скрипт, который:
- Выводит сообщение в консоль
- "Засыпает" на 1 секунду
- Защищён от повторного запуска, если уже работает (блокировка на Redis)

**Решение**:
- Используется **Redis** для хранения блокировки
- Ключ: `lock`, значение: уникальный `runId`
- Установка с `NX` (only if not exists) и `EX`
- Атомарное удаление через **Lua-скрипт**, чтобы не удалить чужую блокировку

Для проверки:
- Написан **Node.js-скрипт**, который запускает PHP-скрипт **1000 раз одновременно**
- Используется `child_process.spawn` — асинхронные вызовы без задержки
- Благодаря блокировке — работает **только один экземпляр**

---
### 2. Триггер в PostgreSQL для сбора статистики

**Задача**:  
Создать таблицы и триггер, который при вставке заказа **автоматически обновляет статистику** по категориям и дням.  
Приоритет — **максимальная производительность**.

**Таблицы**:
- `categories` — категории товаров
- `products` — товары с привязкой к категории
- `orders` — заказы (с датой покупки)
- `statistics` — агрегированная статистика: сколько товаров и заказов за день

**Триггер**:
- Срабатывает `AFTER INSERT ON orders`
- Вставляет или обновляет строку в `statistics` с помощью `ON CONFLICT`
- Не делает лишний запрос для получения категории товара, так как category_id хранится в orders
- Оптимизирован: есть индекс `(category_id, report_date)`
---

## Как запустить
### 1. Клонировать репозиторий
```shell
git clone https://github.com/VladislavTeteryatnikov/werent_test.git
```
### 2. Перейти в папку проекта
```shell
cd werent_test
```

### 3. Поднять docker-контейнеры
```shell
docker compose up -d --build
```
При первом запуске, выполнится инициализация БД (будут созданы таблицы и заполнены тестовыми данными)

### 4. Запустить 1-ое задание
```shell
docker exec -it node node run.js
```
В консоль будет выведена вся информация

### 5. Проверить статистику в PostgreSQL (2-ое задание)
```shell
docker exec -it postgres psql -U user -d werent
```
```shell
SELECT * FROM statistics;
```
Триггер находится: *_scripts/task_2/init/007_create_statistics_trigger.sql*